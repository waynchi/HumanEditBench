import requests 
import xml.etree.ElementTree 
import datetime 
import pickle 
import json
import aiofiles
import asyncio

# klasa waluta
class valute():
    """Waluta i wszystko z nią związane, przez Bank Centralny Federacji Rosyjskiej

Wymagane biblioteki:

requests

xml.etree.ElementTree

datetime

pickle

json"""
    def __init__(self, name):
        self.name = name
    async def correct_name(self):
        """Sprawdzanie nazwy waluty w zbiorze walut. Zbiór jest aktualizowany nie częściej niż raz dziennie"""
        async with aiofiles.open(r"D:\MoexAPI_bot_aiogram3\data_files\Info.json", mode='r', encoding="utf-8") as info_opened_file:
            info = json.loads(await info_opened_file.read())
        if datetime.datetime.now() - datetime.timedelta(days=1) > datetime.datetime.strptime(info["last_day_check"]["valute"], "%Y-%m-%d %H:%M:%S.%f"): 
            # jeśli różni się o więcej niż 1 dzień, to przepisujemy listę (zbiór) walut:
            set_valutes = set() # tworzymy pusty zbiór, do którego będziemy dodawać waluty
            s = "http://www.cbr.ru/scripts/XML_daily.asp"
            r = requests.get(s)
            root = xml.etree.ElementTree.fromstring(r.content) # Żądanie i tak zwraca dane strony jako ciąg znaków, więc bez fromstring się nie obejdzie.
            for Valute in root.findall("Valute"):
                CharCode = Valute.find("CharCode")
                set_valutes.add(CharCode.text) # wlewamy waluty do naszego zbioru
            async with aiofiles.open(r"D:\MoexAPI_bot_aiogram3\data_files\set_valutes.bin", mode='wb') as set_valutes_file_opened:
                await set_valutes_file_opened.write(pickle.dumps(set_valutes)) 
            # zmienimy czas ostatniej aktualizacji
            info["last_day_check"]["valute"] = str(datetime.datetime.now())
            async with aiofiles.open(r"D:\MoexAPI_bot_aiogram3\data_files\Info.json", mode='w', encoding="utf-8") as info_opened_file:
                await info_opened_file.write(json.dumps(info, indent = 3, ensure_ascii = False)) 
        # teraz po prostu sprawdzimy, czy waluta jest na liście walut
        async with aiofiles.open(r"D:\MoexAPI_bot_aiogram3\data_files\set_valutes.bin", mode='rb') as set_valutes_file_opened:
            set_valutes = pickle.loads(await set_valutes_file_opened.read()) 
        if self.name in set_valutes: # po prostu sprawdzamy, czy waluta jest w zbiorze tickerów
            return True
        else:
            return False
    def CurrentExchangeRate(self):
        '''Bieżący kurs wymiany waluty na rubla'''
        r = requests.get("http://www.cbr.ru/scripts/XML_daily.asp") # Api Banku Centralnego Federacji Rosyjskiej
        root = xml.etree.ElementTree.fromstring(r.content)
        for Valute in root.findall("Valute"): # szukamy kontenerów waluty
            for CharCode in Valute.findall("CharCode"): # szukamy kontenerów charcode'ów
                if CharCode.text == self.name: # znajdujemy kontener z potrzebną walutą
                    return (Valute.find("VunitRate").text)