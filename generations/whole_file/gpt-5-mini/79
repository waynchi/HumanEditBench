function createTurnState(allyStates, foeStates) {
  // Find current turn based wich group still has units that can act

  // Determine which side has units that can act (hasActed === false/undefined)
  function groupHasUnitsCanAct(group) {
    return group.some(unit => !unit.hasActed);
  }

  const alliesCanAct = groupHasUnitsCanAct(allyStates);
  const foesCanAct = groupHasUnitsCanAct(foeStates);

  // Decide starting current turn based on who still has units that can act.
  // Priority: if only allies can act -> "player"; if only foes can act -> "cpu";
  // if both can act -> default to "player"; if neither can act -> reset all and start with "player".
  let currentTurn;
  if (alliesCanAct && !foesCanAct) {
    currentTurn = "player";
  } else if (foesCanAct && !alliesCanAct) {
    currentTurn = "cpu";
  } else if (alliesCanAct && foesCanAct) {
    currentTurn = "player";
  } else {
    // No one can act: reset all units' hasActed to false and start with player
    allyStates.forEach(unit => unit.hasActed = false);
    foeStates.forEach(unit => unit.hasActed = false);
    currentTurn = "player";
  }

  let turnNumber = 1;

  function getCurrentTurn() {
    return currentTurn;
  }

  function getTurnNumber() {
    return turnNumber;
  }

  function nextTurn() {
    if (currentTurn === "player") {
      currentTurn = "cpu";
      // CPU logic here (e.g., AI movement and actions)
      allyStates.forEach(unit => unit.hasActed = true);
      foeStates.forEach(unit => unit.hasActed = false);
      cpuTurn();
    } else {
      currentTurn = "player";
      foeStates.forEach(unit => unit.hasActed = true);
      allyStates.forEach(unit => unit.hasActed = false);
      turnNumber++; // Increment turn number only after player's turn
    }
     // Reset action availability for all units at the start of a new turn
  }

  function cpuTurn() {
    // Example CPU behavior (replace with your actual AI logic)
    for (const cpuUnit of foeStates) {
      if (!cpuUnit.hasActed) { // Check if the unit has already acted in this turn
        // Perform CPU actions (e.g., movement, attack)
        // ... your CPU AI logic here ...

        cpuUnit.hasActed = true; // Mark the unit as having acted
      }
    }

    // After all CPU units have acted (or chosen not to), end the CPU turn
    nextTurn(); // Automatically switch back to player's turn
  }  

  return {
    getCurrentTurn,
    getTurnNumber,
    nextTurn
  };
}

export { createTurnState };