import random
import logging
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.common.exceptions import NoSuchElementException, TimeoutException
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import time

class SearchModule:
    def __init__(self, driver, config):
        self.driver = driver
        self.config = config
        self.search_engine = config.get('Search', 'search_engine')
        self.queries = [q.strip() for q in config.get('Search', 'queries').split(',')]
        self.random_query = config.getboolean('Search', 'random_query')

    def perform_search(self):
        query = random.choice(self.queries) if self.random_query else self.queries[0]
        logging.info(f"Performing search with query: {query}")

        if self.search_engine.lower() == 'google':
            self.driver.get("https://www.google.com")
            try:
                search_box = WebDriverWait(self.driver, 10).until(
                    EC.presence_of_element_located((By.NAME, "q"))
                )
            except TimeoutException:
                logging.error("Failed to find search box on Google.")
                return
        elif self.search_engine.lower() == 'yandex':
            self.driver.get("https://ya.ru")
            try:
                search_box = WebDriverWait(self.driver, 10).until(
                    EC.presence_of_element_located((By.CSS_SELECTOR, 'input[placeholder="Найдётся всё"]'))
                )
            except TimeoutException:
                logging.error("Failed to find search box on Yandex.")
                return
        elif self.search_engine.lower() == 'bing':
            self.driver.get("https://www.bing.com")
            try:
                search_box = WebDriverWait(self.driver, 10).until(
                    EC.presence_of_element_located((By.NAME, "q"))
                )
            except TimeoutException:
                logging.error("Failed to find search box on Bing.")
                return
        else:
            logging.error("Unsupported search engine.")
            return

        try:
            search_box.send_keys(query + Keys.RETURN)
        except Exception as e:
            logging.error(f"Failed to perform search: {e}")
            return
        time.sleep(random.uniform(2, 4))  # 等待加载结果

    def navigate_random_link(self):
        logging.info("Navigating to a random search result link.")
        if self.search_engine.lower() == 'google':
            try:
                links = WebDriverWait(self.driver, 10).until(
                    EC.presence_of_all_elements_located((By.CSS_SELECTOR, 'div.yuRUbf > a'))
                )
            except TimeoutException:
                logging.error("Failed to find search result links on Google.")
                return
        elif self.search_engine.lower() == 'yandex':
            try:
                links = WebDriverWait(self.driver, 10).until(
                    EC.presence_of_all_elements_located((By.CSS_SELECTOR, 'a.link'))
                )
            except TimeoutException:
                logging.error("Failed to find search result links on Yandex.")
                return
        elif self.search_engine.lower() == 'bing':
            try:
                links = WebDriverWait(self.driver, 10).until(
                    EC.presence_of_all_elements_located((By.CSS_SELECTOR, 'li.b_algo h2 a'))
                )
            except TimeoutException:
                logging.error("Failed to find search result links on Bing.")
                return
        else:
            logging.error("Unsupported search engine.")
            return

        if not links:
            logging.warning("No links found on the search results page.")
            return

        random_link = random.choice(links)
        try:
            href = random_link.get_attribute('href')
        except Exception as e:
            logging.error(f"Failed to get href from link: {e}")
            return
        logging.info(f"Navigating to: {href}")
        try:
            self.driver.get(href)
        except Exception as e:
            logging.error(f"Failed to navigate to link: {e}")
            return
        time.sleep(random.uniform(3, 6))  # 等待页面加载