# Carpeta con todas las fotos / carpeta con fotos para entrenamiento
TRAIN_DIR = os.path.join(DATA_PATH, "train")
# Leemos los nombres de los directorios, que son el tipo de eclipse
ECLIPSE_LIST = {i:name for i, name in enumerate(os.listdir(TRAIN_DIR))}

# Tipo de fotos
PHOTO_TYPES_DIR = os.path.join(DATA_PATH, "photo_types")
os.makedirs(PHOTO_TYPES_DIR, exist_ok=True)

# Carpeta con fotos para entrenamiento
TRAIN_PHOTO_DIR = os.path.join(PHOTO_TYPES_DIR, "train")
os.makedirs(TRAIN_PHOTO_DIR, exist_ok=True)

# Carpeta con fotos para validación
VAL_PHOTO_DIR = os.path.join(PHOTO_TYPES_DIR, "val")
os.makedirs(VAL_PHOTO_DIR, exist_ok=True)

# Carpeta con fotos para prueba
TEST_DIR = os.path.join(DATA_PATH, "test")

# Proporción de imágenes en la validación
VAL_FRAC = 0.3

# Creamos un directorio con el conjunto de validación para cada tipo de eclipse.
for eclipse in ECLIPSE_LIST.values():
    os.makedirs(os.path.join(TRAIN_PHOTO_DIR, eclipse), exist_ok=True)
    os.makedirs(os.path.join(VAL_PHOTO_DIR, eclipse), exist_ok=True)

    # Leemos el conjunto de imágenes.
    eclipse_path = os.path.join(TRAIN_DIR, eclipse)
    
    # Ordenamos las imágenes para la determinación
    images_filename = sorted(os.listdir(eclipse_path))
    
    # Seleccionamos parte de las imágenes para validación
    # Seleccionamos imágenes aleatorias de la muestra para validación, con random_state establecido
    num_images = len(images_filename)
    num_val = int(num_images * VAL_FRAC)
    indices = sample_without_replacement(num_images, num_val, random_state=42)
    val_images = np.take(images_filename, indices)

    print(f'{eclipse} | train images = {num_images - num_val} | val images = {num_val}')
    
    # Guardamos el conjunto de validación
    for image_filename in val_images:
        source = os.path.join(TRAIN_DIR, eclipse, image_filename)
        destination = os.path.join(VAL_PHOTO_DIR, eclipse, image_filename)
        shutil.copy(source, destination)
        os.remove(source)

    # actualizamos TRAIN_DIR con la nueva estructura
    TRAIN_DIR = os.path.join(PHOTO_TYPES_DIR, "train")

# guardamos las clases de las imagenes
for eclipse in ECLIPSE_LIST.values():
    eclipse_path = os.path.join(TRAIN_DIR, eclipse)
    images_filename = os.listdir(eclipse_path)
    num_images = len(images_filename)
    print(f'{eclipse} | train images = {num_images}')
