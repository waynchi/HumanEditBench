import random
import logging
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.common.exceptions import NoSuchElementException, TimeoutException, WebDriverException
import time

class SearchModule:
    def __init__(self, driver, config):
        self.driver = driver
        self.config = config
        self.search_engine = config.get('Search', 'search_engine')
        self.queries = [q.strip() for q in config.get('Search', 'queries').split(',')]
        self.random_query = config.getboolean('Search', 'random_query')

    def perform_search(self):
        try:
            query = random.choice(self.queries) if self.random_query else self.queries[0]
            logging.info(f"Performing search with query: {query}")

            search_box = None
            
            if self.search_engine.lower() == 'google':
                try:
                    self.driver.get("https://www.google.com")
                    search_box = self.driver.find_element(By.NAME, "q")
                except (NoSuchElementException, WebDriverException) as e:
                    logging.error(f"Failed to find Google search box: {e}")
                    return
            elif self.search_engine.lower() == 'yandex':
                try:
                    self.driver.get("https://ya.ru")
                    search_box = self.driver.find_element(By.CSS_SELECTOR, 'input[placeholder="Найдётся всё"]')
                except (NoSuchElementException, WebDriverException) as e:
                    logging.error(f"Failed to find Yandex search box: {e}")
                    return
            elif self.search_engine.lower() == 'bing':
                try:
                    self.driver.get("https://www.bing.com")
                    search_box = self.driver.find_element(By.NAME, "q")
                except (NoSuchElementException, WebDriverException) as e:
                    logging.error(f"Failed to find Bing search box: {e}")
                    return
            else:
                logging.error("Unsupported search engine.")
                return

            if search_box:
                try:
                    search_box.send_keys(query + Keys.RETURN)
                    time.sleep(random.uniform(2, 4))  # Ожидание загрузки результатов
                except WebDriverException as e:
                    logging.error(f"Failed to perform search: {e}")
                    return
                    
        except Exception as e:
            logging.error(f"Unexpected error in perform_search: {e}")
            return

    def navigate_random_link(self):
        try:
            logging.info("Navigating to a random search result link.")
            links = []
            
            if self.search_engine.lower() == 'google':
                try:
                    links = self.driver.find_elements(By.CSS_SELECTOR, 'div.yuRUbf > a')
                except (NoSuchElementException, WebDriverException) as e:
                    logging.error(f"Failed to find Google search result links: {e}")
                    return
            elif self.search_engine.lower() == 'yandex':
                try:
                    links = self.driver.find_elements(By.CSS_SELECTOR, 'a.link')
                except (NoSuchElementException, WebDriverException) as e:
                    logging.error(f"Failed to find Yandex search result links: {e}")
                    return
            elif self.search_engine.lower() == 'bing':
                try:
                    links = self.driver.find_elements(By.CSS_SELECTOR, 'li.b_algo h2 a')
                except (NoSuchElementException, WebDriverException) as e:
                    logging.error(f"Failed to find Bing search result links: {e}")
                    return
            else:
                logging.error("Unsupported search engine.")
                return

            if not links:
                logging.warning("No links found on the search results page.")
                return

            try:
                random_link = random.choice(links)
                href = random_link.get_attribute('href')
                
                if not href:
                    logging.warning("Selected link has no href attribute.")
                    return
                    
                logging.info(f"Navigating to: {href}")
                self.driver.get(href)
                time.sleep(random.uniform(3, 6))  # Ожидание загрузки страницы
                
            except WebDriverException as e:
                logging.error(f"Failed to navigate to random link: {e}")
                return
                
        except Exception as e:
            logging.error(f"Unexpected error in navigate_random_link: {e}")
            return